<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SelectBook | Demo CBT Test</title>

<style>
:root {
    --primary: #00a9d6;        /* teal like Testbook */
    --primary-dark: #008cb3;
    --header-bg: #ffffff;
    --border: #d4dde7;
    --bg-soft: #f4f7fb;
    --danger: #f35b4f;
    --success: #3ab54a;
    --text-main: #222;
    --text-muted: #777;
}

/* RESET */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: radial-gradient(circle at top, #ffffff 0, #f4f7fb 40%, #e5edf7 100%);
    color: var(--text-main);
}

/* HEADER: TIMER + FULLSCREEN */
.top-bar {
    background: var(--header-bg);
    border-bottom: 1px solid var(--border);
    padding: 8px 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 1px 4px rgba(0,0,0,0.05);
}

.timer-display {
    display: inline-flex;
    align-items: center;
    padding: 6px 10px;
    border-radius: 4px;
    border: 1px solid var(--border);
    background: #fafafa;
    font-weight: 600;
    font-size: 15px;
    gap: 2px;
}
.timer-box {
    padding: 4px 6px;
    border-radius: 3px;
    background: #263238;
    color: #fff;
    min-width: 26px;
    text-align: center;
    font-size: 13px;
}
.timer-colon {
    font-size: 13px;
    padding: 0 2px;
}

.btn-outline {
    padding: 7px 16px;
    border-radius: 4px;
    background: #ffffff;
    border: 1px solid var(--primary);
    color: var(--primary-dark);
    font-size: 14px;
    cursor: pointer;
    font-weight: 500;
}
.btn-outline:hover {
    background: #e0f7ff;
}

/* SECOND BAR: SECTION / TEST TAB */
.nav-bar {
    background: #f9fbff;
    border-bottom: 1px solid var(--border);
    padding: 0 14px;
    display: flex;
    align-items: flex-end;
    gap: 16px;
}

.nav-tab {
    padding: 9px 18px;
    border-radius: 4px 4px 0 0;
    border: 1px solid transparent;
    border-bottom: none;
    font-size: 14px;
    cursor: pointer;
    background: transparent;
    color: #555;
}
.nav-tab.active {
    background: #ffffff;
    border-color: var(--border);
    border-bottom: 1px solid #ffffff;
    color: var(--primary-dark);
    font-weight: 600;
}

/* LAYOUT WRAPPER */
.page-wrapper {
    max-width: 1180px;
    margin: 0 auto;
    padding: 14px 10px 18px;
    display: flex;
}

/* QUESTION CONTAINER */
.question-container {
    flex: 1;
    background: #ffffff;
    border-radius: 0 0 8px 8px;
    border: 1px solid var(--border);
    padding: 16px 18px 88px; /* ‡§®‡•Ä‡§ö‡•á button bar ‡§ï‡•á ‡§≤‡§ø‡§è space */
    min-height: calc(100vh - 130px);
    position: relative;
    box-shadow: 0 8px 20px rgba(0,0,0,0.04);
}

/* QUESTION HEADER */
.q-header-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 10px;
    gap: 10px;
    flex-wrap: wrap;
}

.q-title {
    font-weight: 650;
    font-size: 18px;
}

.q-info-row {
    display: flex;
    align-items: center;
    gap: 16px;
    font-size: 14px;
}

.chip {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 13px;
    color: #fff;
}
.chip-green {
    background: var(--success);
}
.chip-red {
    background: var(--danger);
}
.chip-label {
    font-weight: 600;
}

.q-info-label {
    font-size: 13px;
    color: #555;
    margin-right: 4px;
}

.q-time {
    font-size: 14px;
}

/* language dropdown + alert */
.q-header-bottom {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
    flex-wrap: wrap;
}
.select-small {
    padding: 5px 24px 5px 8px;
    border-radius: 4px;
    border: 1px solid var(--border);
    font-size: 14px;
    background: #fff;
}
.alert-icon {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 13px;
    color: #666;
    cursor: pointer;
}
.alert-symbol {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    border: 1px solid #777;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
}

/* QUESTION TEXT + OPTIONS */
.q-body {
    font-size: 15px;
    line-height: 1.6;
}
.q-body p {
    margin-bottom: 10px;
}
.options {
    list-style: none;
    margin-top: 4px;
    padding-left: 0;
}
.options li {
    margin-bottom: 8px;
    padding: 6px 8px;
    border-radius: 6px;
    transition: background 0.15s ease;
}
.options li:hover {
    background: #f4f9ff;
}
.options label {
    cursor: pointer;
}
.options input {
    margin-right: 6px;
}

/* BOTTOM BUTTON BAR */
.bottom-bar {
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    bottom: 0;
    width: 100%;
    max-width: 1180px;
    padding: 8px 10px 10px;
    background: #eaf1f8;
    border-top: 1px solid var(--border);
}
.bottom-inner {
    background: #f9fcff;
    border-radius: 6px;
    border: 1px solid var(--border);
    padding: 8px 10px;
    display: flex;
    justify-content: space-between; /* left group + right group */
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}

.bottom-left,
.bottom-right {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
}

.btn-flat {
    padding: 9px 18px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
}
.btn-grey {
    background: #e2efff;
    color: #0a3b60;
}
.btn-teal {
    background: var(--primary);
    color: #fff;
}
.btn-teal:hover {
    background: var(--primary-dark);
}

/* ========== PALETTE HANDLE (BLACK BAR) ========== */
.palette-handle {
    position: fixed;
    top: 40%; /* ‡§•‡•ã‡§°‡§º‡§æ ‡§ä‡§™‡§∞ ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ */
    right: 0;
    transform: translateY(-50%);
    width: 30px;
    height: 90px;
    background: #222;
    color: #fff;
    border-radius: 4px 0 0 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 900;
}
.palette-handle span {
    font-size: 18px;
}

/* ========== PALETTE OVERLAY PANEL ========== */
.palette-overlay {
    position: fixed;
    top: 0;
    right: 0;
    width: 340px;
    max-width: 92%;
    height: 100vh;
    background: #e5f4ff;
    box-shadow: -4px 0 16px rgba(0,0,0,0.25);
    transform: translateX(100%);
    transition: transform 0.25s ease;
    z-index: 950;
    display: flex;
    flex-direction: column;
}

.palette-overlay.open {
    transform: translateX(0);
}

.palette-header {
    padding: 10px 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.user-info {
    display: flex;
    align-items: center;
    gap: 8px;
}
.user-avatar {
    width: 34px;
    height: 34px;
    border-radius: 50%;
    background: #b0c4de;
}
.user-name {
    font-size: 14px;
    font-weight: bold;
}

.palette-close {
    cursor: pointer;
    font-size: 24px;
    line-height: 1;
}

/* palette stats row */
.palette-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 10px 14px;
    padding: 6px 14px 10px;
    font-size: 13px;
}
.stat-item {
    display: flex;
    align-items: center;
    gap: 6px;
}
.stat-dot {
    width: 16px;
    height: 16px;
    border-radius: 50%;
}
.dot-answered { background:#3ab54a; }
.dot-marked { background:#9c27b0; }
.dot-marked-answered { background:#3ab54a; border:3px solid #9c27b0; }
.dot-notvisited { background:#ffffff; border:1px solid #777; }
.dot-notanswered { background:#f35b4f; }

/* section title */
.section-title {
    padding: 8px 14px;
    font-size: 13px;
    font-weight: bold;
    border-top: 1px solid rgba(0,0,0,0.06);
}

/* palette grid */
.palette-grid {
    flex: 1;
    padding: 10px 14px 6px;
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 8px 6px;
    overflow-y: auto; /* grid scroll, footer ‡§π‡§Æ‡•á‡§∂‡§æ ‡§®‡•Ä‡§ö‡•á ‡§¶‡§ø‡§ñ‡•á */
}
.q-num-btn {
    width: 38px;
    height: 32px;
    border-radius: 4px;
    border: 1px solid #333;
    background: #ffffff;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}
.q-num-btn.current {
    border-width: 2px;
    border-color: var(--primary);
}
.q-num-btn.answered {
    background: #d2f5d8;
    border-color: #2e7d32;
}
.q-num-btn.review {
    background: #f3e5f5;
    border-color: #8e24aa;
}

/* bottom buttons inside palette */
.palette-footer {
    padding: 8px 14px 12px;
    border-top: 1px solid rgba(0,0,0,0.08);
    flex-shrink: 0; /* ‡§π‡§Æ‡•á‡§∂‡§æ ‡§¶‡§ø‡§ñ‡•á */
}
.palette-footer-buttons {
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.btn-palette {
    padding: 9px 12px;
    border-radius: 4px;
    border: 1px solid #a3c2d9;
    background: #f3fbff;
    cursor: pointer;
    font-size: 14px;
}
.btn-submit {
    background: #ffeced;
    border-color: #f4a6aa;
    color: #c4373d;
}

/* RESPONSIVE */
@media (max-width: 700px) {
    .q-title {
        font-size: 16px;
    }
    .q-header-top {
        align-items: flex-start;
    }
    .top-bar {
        flex-direction: row;
        gap: 10px;
    }
    .timer-display {
        font-size: 13px;
    }
    .page-wrapper{
        padding:10px 4px 80px;
    }
    .question-container{
        padding:12px 10px 96px;
    }
    .bottom-bar{
        padding:6px 4px 8px;
    }
    /* üîß MOBILE BOTTOM BAR FIX */
.bottom-inner{
    flex-direction: row;        /* ‡§§‡•Ä‡§®‡•ã‡§Ç ‡§¨‡§ü‡§® ‡§è‡§ï ‡§≤‡§æ‡§á‡§® ‡§Æ‡•á‡§Ç */
    align-items: center;
}

.bottom-left{
    flex: 2;
    display: flex;
    gap: 8px;                   /* Mark for Review ‚Üî Clear */
}

.bottom-right{
    flex: 1;
    margin-left: 14px;          /* üî• Clear ‚Üî Save & Next SAFE GAP */
}

.btn-flat{
    padding: 10px 8px;
    font-size: 13px;
    white-space: nowrap;
}
}
</style>
</head>
<body>

<!-- TOP BAR: TIMER + FULL SCREEN -->
<div class="top-bar">
    <div class="timer-display" id="timer">
        <span class="timer-box" id="tm-hr">00</span>
        <span class="timer-colon">:</span>
        <span class="timer-box" id="tm-min">09</span>
        <span class="timer-colon">:</span>
        <span class="timer-box" id="tm-sec">59</span>
    </div>
<button class="btn-outline" id="pause-btn">Pause</button>
    <button class="btn-outline" id="fs-btn">Full Screen</button>
</div>

<!-- SECOND NAV BAR -->
<div class="nav-bar">
    <button class="nav-tab">SECTIONS</button>
    <button class="nav-tab active">Test</button>
</div>

<!-- MAIN CONTENT -->
<div class="page-wrapper">
    <div class="question-container">
        <!-- HEADER TOP -->
        <div class="q-header-top">
            <div class="q-title">Question No. 1</div>

            <div class="q-info-row">
                <div>
                    <span class="q-info-label">Marks</span>
                    <span class="chip chip-green"><span class="chip-label">+1</span></span>
                    <span class="chip chip-red" style="margin-left:4px;"><span class="chip-label">-0.33</span></span>
                </div>

                <div class="q-time">
                    <span class="q-info-label">Time</span>
                    01:30
                </div>
            </div>
        </div>

        <!-- HEADER bottom: language + alert -->
        <div class="q-header-bottom">
            <div style="display:flex;align-items:center;gap:6px;">
                <span class="q-info-label">View in</span>
                <select class="select-small">
                    <option>Hindi</option>
                    <option>English</option>
                </select>
            </div>

            <div class="alert-icon">
                <span class="alert-symbol">!</span>
                <span>‡§∏‡•Ç‡§ö‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç</span>
            </div>
        </div>

        <!-- QUESTION BODY (loaded via JS) -->
        <div class="q-body" id="q-body">
            <!-- JS ‡§∏‡•á 10 sample questions render ‡§π‡•ã‡§Ç‡§ó‡•á -->
        </div>
    </div>
</div>

<!-- BOTTOM BUTTON BAR -->
<div class="bottom-bar">
    <div class="bottom-inner">
        <div class="bottom-left">
            <div class="bottom-left">
    <button class="btn-flat btn-grey" id="btn-review">
    Mark for Review
</button>
    <button class="btn-flat btn-grey" id="btn-clear">
        Clear Response
    </button>
</div>
        </div>
        <div class="bottom-right">
    <button class="btn-flat btn-teal" id="btn-next">
        Save &amp; Next ‚Üí
    </button>
</div>
        </div>
    </div>
</div>

<!-- VERTICAL HANDLE -->
<div class="palette-handle" id="palette-handle">
    <span>&gt;</span>
</div>

<!-- PALETTE OVERLAY -->
<div class="palette-overlay" id="palette">
    <div class="palette-header">
        <div class="user-info">
            <div class="user-avatar"></div>
            <div class="user-name">Demo Candidate</div>
        </div>
        <div class="palette-close" id="palette-close">&times;</div>
    </div>

    <div class="palette-stats">
        <div class="stat-item">
            <span class="stat-dot dot-answered"></span>
            <span>Answered</span>
        </div>
        <div class="stat-item">
            <span class="stat-dot dot-marked"></span>
            <span>Marked for Review</span>
        </div>
        <div class="stat-item">
            <span class="stat-dot dot-notvisited"></span>
            <span>Not Visited</span>
        </div>
        <div class="stat-item">
            <span class="stat-dot dot-notanswered"></span>
            <span>Not Answered</span>
        </div>
    </div>

    <div class="section-title">
        SECTION : Demo Test (10 Questions)
    </div>

    <div class="palette-grid" id="palette-grid">
        <!-- 1-10 buttons JS ‡§∏‡•á ‡§¨‡§®‡•á‡§Ç‡§ó‡•á -->
    </div>

    <div class="palette-footer">
        <div class="palette-footer-buttons">
            <button class="btn-palette" onclick="openQuestionPaper()">Question Paper</button>
            <button class="btn-palette" onclick="openInstructions()">Instructions</button>
            <button class="btn-palette" onclick="openSubmitConfirm()">Submit Test</button>
        </div>
    </div>
</div>
<!-- ================= PAUSE OVERLAY ================= -->
<div id="pause-overlay" style="
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.6);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:2000;
    pointer-events: all;
">
    <div style="
        background:#fff;
        padding:20px 26px;
        border-radius:8px;
        text-align:center;
        max-width:260px;
    ">
        <h3 style="margin-bottom:10px;">‚è∏Ô∏è Test Paused</h3>
        <p style="font-size:14px;margin-bottom:14px;">
            Test resume ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è Resume ‡§¶‡§¨‡§æ‡§è‡§Å
        </p>
        <button class="btn-outline" id="resume-btn">Resume</button>
    </div>
</div>
<!-- ================= PAUSE OVERLAY END ================= -->
<!-- ================= SUBMIT CONFIRM MODAL ================= -->
<div id="submit-confirm-modal" style="
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.6);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:2100;
">
    <div style="
        background:#fff;
        padding:20px 22px;
        border-radius:8px;
        width:90%;
        max-width:320px;
        text-align:center;
    ">
        <h3 style="margin-bottom:10px;">‚ö†Ô∏è Confirm Submission</h3>

        <div id="submit-summary" style="
            font-size:14px;
            margin-bottom:14px;
            text-align:left;
        ">
            <!-- JS ‡§∏‡•á summary ‡§Ü‡§è‡§ó‡•Ä -->
        </div>

        <div style="display:flex; gap:10px;">
            <button class="btn-outline" style="flex:1;"
                onclick="closeSubmitConfirm()">
                Cancel
            </button>

            <button class="btn-flat" style="flex:1;"
                onclick="confirmSubmitTest()">
                Yes, Submit
            </button>
        </div>
    </div>
</div>
<!-- ================= SUBMIT CONFIRM MODAL END ================= -->
<script>
// ========== GLOBAL DATA ==========
// ===== STEP 10.1: READ EXAM & TEST FROM URL =====
const urlParams = new URLSearchParams(window.location.search);
const CURRENT_EXAM_KEY = urlParams.get("exam");
const CURRENT_TEST_KEY = urlParams.get("test");

console.log("STEP 10.1 ‚Üí Exam:", CURRENT_EXAM_KEY);
console.log("STEP 10.1 ‚Üí Test:", CURRENT_TEST_KEY);
// questions.json ‡§∏‡•á ‡§Ü‡§è‡§Ç‡§ó‡•á
let questions = [];
// current question index
let currentIndex = 0;
// user ‡§ï‡•á ‡§ú‡§µ‡§æ‡§¨
let userAnswers = [];
// mark for review
let reviewStatus = [];
// exam configuration (JSON ‡§∏‡•á)
let examConfig = {};
let marksRule = {};

// Timer
let totalSeconds = 9 * 60 + 59;           // demo: 9 min 59 sec
let testStartTime = Date.now();
let INITIAL_SECONDS = totalSeconds;     // ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç time taken ‡§®‡§ø‡§ï‡§æ‡§≤‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è

// ===== PAUSE STATE =====
let isPaused = false;
let testSubmitted = false;
// ========== PAUSE / RESUME HANDLERS ==========
const pauseBtn = document.getElementById("pause-btn");
const resumeBtn = document.getElementById("resume-btn");
const pauseOverlay = document.getElementById("pause-overlay");

if (pauseBtn) {
    pauseBtn.addEventListener("click", () => {
        isPaused = true;
        if (pauseOverlay) pauseOverlay.style.display = "flex";
    });
}

if (resumeBtn) {
    resumeBtn.addEventListener("click", () => {
        isPaused = false;
        if (pauseOverlay) pauseOverlay.style.display = "none";
    });
}
// ========== QUESTIONS LOAD (JSON ‡§∏‡•á) ==========
async function loadQuestions(){
    try{
        let questionsPath = "questions.json";

        if (CURRENT_EXAM_KEY && CURRENT_TEST_KEY) {
            questionsPath = `data/tests/${CURRENT_EXAM_KEY}/${CURRENT_TEST_KEY}.json`;
        }

        console.log("STEP 10.2 ‚Üí Loading questions from:", questionsPath);

        const res = await fetch(questionsPath);
        const data = await res.json();

        examConfig = data.exam || {};
        marksRule  = data.marksRule || {};
        questions  = data.questions || [];

        userAnswers  = new Array(questions.length).fill(null);
        reviewStatus = new Array(questions.length).fill(false);

        if (examConfig.totalTime) {
    totalSeconds = examConfig.totalTime * 60;
    INITIAL_SECONDS = totalSeconds;   // üî• THIS LINE FIXES TIME TAKEN
}

        renderQuestion(0);
        buildPalette();

    }catch(err){
        console.error("Error loading questions", err);
        document.getElementById("q-body").innerHTML =
          "<p style='color:red;'>Questions load ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§™‡§æ‡§è.</p>";
    }
}

// ========== QUESTION RENDER ==========
function renderQuestion(index){
    if(!questions.length) return;

    currentIndex = index;
    const q = questions[index];
    const titleEl = document.querySelector(".q-title");
    const bodyEl  = document.getElementById("q-body");

    titleEl.textContent = "Question No. " + (index + 1);

    let html = "";
    html += "<p>" + q.text + "</p>";
    html += '<ul class="options">';
    (q.options || []).forEach((opt, i) => {
        const checked = userAnswers[index] === i ? "checked" : "";
        html += `
        <li>
          <label>
            <input type="radio"
                   name="q${index}"
                   value="${i}"
                   ${checked}
                   onclick="selectOption(${index}, ${i})">
            ${opt}
          </label>
        </li>`;
    });
    html += "</ul>";

    bodyEl.innerHTML = html;
// üîù AUTO SCROLL TO TOP (STEP 8)
window.scrollTo({
    top: 0,
    behavior: "smooth"
});
    // palette ‡§Æ‡•á‡§Ç current highlight
    document.querySelectorAll(".q-num-btn").forEach((btn, i) => {
        btn.classList.toggle("current", i === index);
    });
}

// ========== OPTION SELECT ==========
function selectOption(qIndex, optIndex){
userAnswers[qIndex] = Number(optIndex);

    const btn = document.querySelectorAll(".q-num-btn")[qIndex];
    if(btn){
        btn.classList.add("answered");
        btn.classList.remove("review");
    }
}

// ========== NAVIGATION BUTTONS ==========
document.getElementById("btn-next").addEventListener("click", () => {
    if(currentIndex < questions.length - 1){
        renderQuestion(currentIndex + 1);
    }else{
        // ‡§Ü‡§ñ‡§ø‡§∞‡•Ä question ‡§™‡§∞ Save & Next ‚Üí submit popup
        const ok = confirm("‡§Ø‡§π ‡§Ü‡§ñ‡§ø‡§∞‡•Ä ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§π‡•à‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§ü‡•á‡§∏‡•ç‡§ü ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?");
        if(ok) submitTest();
    }
});


document.getElementById("btn-clear").addEventListener("click", () => {
    userAnswers[currentIndex] = null;
    reviewStatus[currentIndex] = false;
    renderQuestion(currentIndex);

    const btn = document.querySelectorAll(".q-num-btn")[currentIndex];
    if(btn){
        btn.classList.remove("answered", "review");
    }
});

document.getElementById("btn-review").addEventListener("click", () => {
    reviewStatus[currentIndex] = true;

    const btn = document.querySelectorAll(".q-num-btn")[currentIndex];
    if(btn){
        btn.classList.add("review");
    }

    if(currentIndex < questions.length - 1){
        renderQuestion(currentIndex + 1);
    }else{
        const ok = confirm("‡§Ø‡§π ‡§Ü‡§ñ‡§ø‡§∞‡•Ä ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§π‡•à ‡§î‡§∞ Mark for Review ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§ü‡•á‡§∏‡•ç‡§ü ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?");
        if(ok) submitTest();
    }
});

// ========== PALETTE BUILD ==========
function buildPalette(){
    const grid = document.getElementById("palette-grid");
    if(!grid) return;

    grid.innerHTML = "";
    for(let i = 0; i < questions.length; i++){
        const btn = document.createElement("button");
        btn.className = "q-num-btn";
        if(i === 0) btn.classList.add("current");
        btn.textContent = i + 1;
        btn.addEventListener("click", () => renderQuestion(i));
        grid.appendChild(btn);
    }
}
// ========== QUESTION STATUS HELPER ==========
function getQuestionStatus(i) {
    if (userAnswers[i] !== null) return "answered";
    if (reviewStatus[i]) return "review";
    return "unattempted";
}

// ========== FULLSCREEN ==========
const fsBtn = document.getElementById("fs-btn");

function updateFsText(){
    fsBtn.textContent = document.fullscreenElement ? "Exit Full Screen" : "Full Screen";
}

fsBtn.addEventListener("click", () => {
    if(!document.fullscreenElement){
        document.documentElement.requestFullscreen &&
        document.documentElement.requestFullscreen();
    }else{
        document.exitFullscreen && document.exitFullscreen();
    }
});

document.addEventListener("fullscreenchange", updateFsText);

// ========== TIMER ==========
function pad(n){ return n.toString().padStart(2, "0"); }

function updateTimer() {
    if (isPaused) return;   // ‚ùå testSubmitted ‡§Ø‡§π‡§æ‡§Å ‡§®‡§π‡•Ä‡§Ç ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç‡§ó‡•á

    const hr  = Math.floor(totalSeconds / 3600);
    const min = Math.floor((totalSeconds % 3600) / 60);
    const sec = totalSeconds % 60;

    document.getElementById("tm-hr").textContent  = pad(hr);
    document.getElementById("tm-min").textContent = pad(min);
    document.getElementById("tm-sec").textContent = pad(sec);

    if (totalSeconds <= 0) {
        clearInterval(timerInterval);

        submitTest();   // üëà ‡§Ö‡§¨ ‡§Ø‡§π ‡§π‡§Æ‡•á‡§∂‡§æ call ‡§π‡•ã‡§ó‡§æ
        return;
    }

    totalSeconds--;
}

let timerInterval = setInterval(updateTimer, 1000);

// ========== PALETTE OPEN/CLOSE ==========
const palette   = document.getElementById("palette");
const handle    = document.getElementById("palette-handle");
const closeBtn  = document.getElementById("palette-close");

if(handle){
    handle.addEventListener("click", () => {
        palette && palette.classList.add("open");
    });
}
if(closeBtn){
    closeBtn.addEventListener("click", () => {
        palette && palette.classList.remove("open");
    });
}

// ‡§¨‡§æ‡§π‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§®‡•á ‡§™‡§∞ ‡§¨‡§Ç‡§¶ (optional)
document.addEventListener("click", (e) => {
    if(palette &&
       palette.classList.contains("open") &&
       !palette.contains(e.target) &&
       e.target !== handle &&
       !handle.contains(e.target)){
        palette.classList.remove("open");
    }
});

// ========== EXTRA BUTTONS ==========
function openQuestionPaper(){
    // ‡§Ö‡§≠‡•Ä ‡§∏‡§ø‡§∞‡•ç‡§´ palette ‡§¨‡§Ç‡§¶ ‚Äì future ‡§Æ‡•á‡§Ç ‡§Ö‡§≤‡§ó view ‡§¨‡§®‡§æ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç
    if(palette) palette.classList.remove("open");
}

function openInstructions(){
    window.location.href = "exam-instructions.html";
}

// ========== RESULT CALCULATION + SAVE ==========
function calculateAndStoreResult() {

    let attempted = 0;
    let correct = 0;
    let incorrect = 0;

    questions.forEach((q, i) => {
        const userAns = userAnswers[i];

        if (userAns !== null && userAns !== undefined) {
            attempted++;

            if (Number(userAns) === Number(q.answer)) {
                correct++;
            } else {
                incorrect++;
            }
        }
    });

    const totalQuestions = questions.length;
    const unattempted = totalQuestions - attempted;

    const marksPerCorrect = Number(marksRule.correct ?? 1);
    const negativePerWrong = Number(marksRule.negative ?? 0);

    const negativeMarks = incorrect * negativePerWrong;
    const score = (correct * marksPerCorrect) - negativeMarks; // ‚úÖ SINGLE DECLARATION

    const accuracy =
        attempted > 0
            ? ((correct / attempted) * 100).toFixed(2)
            : "0.00";

    const timeTakenSeconds =
        Math.max(0, INITIAL_SECONDS - totalSeconds);

    const mins = Math.floor(timeTakenSeconds / 60);
    const secs = timeTakenSeconds % 60;

    const resultData = {
    totalQuestions,

    attempted,
    correct,
    incorrect,
    unattempted,

    marksPerCorrect,
    negativePerWrong,
    negativeMarks: Number(negativeMarks.toFixed(2)),
    score: Number(score.toFixed(2)),
    accuracy,

    timeTakenSeconds,
    timeTakenText: `${mins}m ${secs}s`,

    // üî• REVIEW PAGE ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ú‡§∞‡•Ç‡§∞‡•Ä data
    questions: questions,
    userAnswers: userAnswers,
    reviewStatus: reviewStatus
};
// üî• REVIEW PAGE COMPATIBILITY (GENERIC)
localStorage.setItem(
  "selectbook-questions",
  JSON.stringify(questions)
);

localStorage.setItem(
  "selectbook-userAnswers",
  JSON.stringify(userAnswers)
);

localStorage.setItem(
  "selectbook-reviewStatus",
  JSON.stringify(reviewStatus)
);
    localStorage.setItem(
        "selectbook-result",
        JSON.stringify(resultData)
    );
}
// ===== SUBMIT CONFIRM MODAL =====
function openSubmitConfirm(){

    const total = questions.length;
    let answered = 0;
    let notAnswered = 0;
    let marked = 0;

    questions.forEach((q, i) => {
        if(userAnswers[i] !== null) answered++;
        else notAnswered++;

        if(reviewStatus[i]) marked++;
    });

    const summary = `
        <p><b>üìä Test Summary</b></p>
        <p>Total Questions: <b>${total}</b></p>
        <p>Answered: <b>${answered}</b></p>
        <p>Not Answered: <b>${notAnswered}</b></p>
        <p>Marked for Review: <b>${marked}</b></p>
        <p style="margin-top:8px;color:#c0392b;">
            ‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§ü‡•á‡§∏‡•ç‡§ü submit ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?
        </p>
    `;

    document.getElementById("submit-summary").innerHTML = summary;
    document.getElementById("submit-confirm-modal").style.display = "flex";
}

function closeSubmitConfirm(){
    document.getElementById("submit-confirm-modal").style.display = "none";
}

function confirmSubmitTest(){
    document.getElementById("submit-confirm-modal").style.display = "none";
    submitTest();   // üëà existing function call
}
// ========== SUBMIT ==========
function submitTest(){

    if (testSubmitted) return;
    testSubmitted = true;

    clearInterval(timerInterval);

    calculateAndStoreResult();

    // file:// + http:// ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§Æ‡•á‡§Ç safe
    window.location.href = "exam-result.html";
}
// ========== MOBILE SWIPE SUPPORT (STEP 7) ==========
(function enableSwipeNavigation(){

    const swipeArea = document.querySelector(".question-container");
    if(!swipeArea) return;

    let startX = 0;
    let startY = 0;

    const SWIPE_THRESHOLD = 70;   // ‡§ï‡§Æ swipe ignore
    const VERTICAL_LIMIT  = 40;   // vertical scroll ignore

    swipeArea.addEventListener("touchstart", function(e){
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
    }, {passive:true});

    swipeArea.addEventListener("touchend", function(e){
        const endX = e.changedTouches[0].clientX;
        const endY = e.changedTouches[0].clientY;

        const diffX = endX - startX;
        const diffY = endY - startY;

        // ‡§Ö‡§ó‡§∞ vertical movement ‡§ú‡•ç‡§Ø‡§æ‡§¶‡§æ ‡§π‡•à ‚Üí ignore
        if(Math.abs(diffY) > VERTICAL_LIMIT) return;

        // üëâ Right swipe = Previous question
        if(diffX > SWIPE_THRESHOLD && currentIndex > 0){
            renderQuestion(currentIndex - 1);
        }

        // üëâ Left swipe = Next question
        if(diffX < -SWIPE_THRESHOLD && currentIndex < questions.length - 1){
            renderQuestion(currentIndex + 1);
        }
    });

})();
// ========== INITIAL LOAD ==========
loadQuestions();
</script>
</body>
</html>